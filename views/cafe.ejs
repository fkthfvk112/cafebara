<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/stylesheets/cafe.css">


    <title>카페를 보여주는 페이지</title>
</head>

<body>
    <% layout('layouts/boilerplate') %>
    <section class="filterSection">
      <div class="row">
        <div class="text-center flex" style="color:#2b2d42; align-items: start;">
          <div class="filterText1" style="color:black; display: inline-block;">Search cafe</div>
          <div class="filterText2" style="color:#96999b; display: inline-block; text-align: start;">menu<span style="font-weight:500; margin: 0 0.2em 0 0.2em;">|</span>name<br>location<span style="font-weight:500; margin: 0 0.2em 0 0.2em;">|</span>star<span style="font-weight:500; margin: 0 0.2em 0 0.2em;">|</span>review</div>
        </div>
        <form action="/cafe/filter"class="d-flex justify-content-center filterForm">
          <div class="filterContainer">
            <input style="min-width: 250px; width:40%;" type="text" name="filter[filterInput]">
            <input class="userLocation" style="display:none;" name="filter[userLocation]">
            <div class="selectContainer">
            <select name = filter[filter1] style="width:130px; font-size: 0.8em;">
              <option value="study">
                공부
              </option>
              <option value="talk">
                수다
              </option>
              <option value="takeOut">
                테이크아웃
              </option>
              <option value="" selected>
                선택 안 함
              </option>
            </select>
            <select class="select2" name = filter[filter2] style="width:130px; font-size: 0.8em;">
              <option value="highStar">
                별점 높은 순
              </option>
              <option value="lowStar">
                별점 낮은 순
              </option>
              <option value="highReview">
                리뷰 많은 순
              </option>
              <option  value="lowReview">
                리뷰 적은 순
              </option>
              <option class="close" value="closeToMe">
                거리 가까운 순
              </option>
              <option selected value="">
                선택 안 함
              </option>
            </select>
          </div>
            <button type="button" class="filterBtn">
              검색
            </button>
          </div>
        </form>
      </div>
    </section>
    <section>
      <div class="cafeContainer" style="margin-top: 100px; margin-bottom: 100px;">
          <% for(let cafe of cafes) { %>
          <div class="cardWrapper">
            <a class='card_link' href="/cafe/<%= cafe._id %>">
              <div class="card mb-3 cafeItem">
                  <div style="height: 28em;">
                    <div >
                      <div style="text-align: center;">
                        <img class="m-3" src="<%= cafe.images[0].url %>" style="height: 10em; object-fit: contain;">
                      </div>
                    </div>
                    <div >
                      <div class="card-body text-start">
                        <h5 class="card-title mb-1 ms-2" style="font-weight:bold; display: inline-block;"><%= cafe.name %></h5>
                        <% if (cafe.purposeTotal === "study") { %>
                          <span class="badge rounded-pill text-bg-primary"><%= cafe.purposeTotal %></span>
                        <% } else if (cafe.purposeTotal === "talk") { %>
                          <span class="badge rounded-pill text-bg-success"><%= cafe.purposeTotal %></span>
                        <% } else if (cafe.purposeTotal === "takeOut") { %>
                          <span class="badge rounded-pill text-bg-info"><%= cafe.purposeTotal %></span>
                        <% } else if (cafe.purposeTotal === "nofeatures") { %>
                          <span class="badge rounded-pill text-bg-secondary"><%= cafe.purposeTotal %></span>
                        <% } %>
                        
                        <div class="mb-3 ms-1">
                          <% for(let i = 0; i < Math.floor(cafe.avgTotal); i++){ %>
                            <span>⭐</span>
                          <% }%>
                          <span style="color:#96999b;"><%=cafe.avgTotal.toFixed(2); %></span>
                        </div>
                        <p class="card-text" style="font-size:0.8em;"><?xml version="1.0" ?><svg height="24" version="1.1" width="24" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"><g transform="translate(0 -1028.4)"><path d="m12.031 1030.4c-3.8657 0-6.9998 3.1-6.9998 7 0 1.3 0.4017 2.6 1.0938 3.7 0.0334 0.1 0.059 0.1 0.0938 0.2l4.3432 8c0.204 0.6 0.782 1.1 1.438 1.1s1.202-0.5 1.406-1.1l4.844-8.7c0.499-1 0.781-2.1 0.781-3.2 0-3.9-3.134-7-7-7zm-0.031 3.9c1.933 0 3.5 1.6 3.5 3.5 0 2-1.567 3.5-3.5 3.5s-3.5-1.5-3.5-3.5c0-1.9 1.567-3.5 3.5-3.5z" fill="#c0392b"/><path d="m12.031 1.0312c-3.8657 0-6.9998 3.134-6.9998 7 0 1.383 0.4017 2.6648 1.0938 3.7498 0.0334 0.053 0.059 0.105 0.0938 0.157l4.3432 8.062c0.204 0.586 0.782 1.031 1.438 1.031s1.202-0.445 1.406-1.031l4.844-8.75c0.499-0.963 0.781-2.06 0.781-3.2188 0-3.866-3.134-7-7-7zm-0.031 3.9688c1.933 0 3.5 1.567 3.5 3.5s-1.567 3.5-3.5 3.5-3.5-1.567-3.5-3.5 1.567-3.5 3.5-3.5z" fill="#d62828" transform="translate(0 1028.4)"/></g></svg> <%= cafe.location %> </p>
                        <% let cnt = 0 %>
                        <hr>
                        <p><%= cafe.description %></p>
                        <!--
                        <% for(let menu of cafe.repreMenu) {%>
                          <span class="card-text"><%= menu.name %>
                          <% if(cnt != 2){%>
                            ,
                          <% } %>
                          <% cnt++ %>
                          </span>
                        <% }  %>
                        -->
                      </div>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          <% } %>
        </div>
    </section>
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous">

</script>
                    
</body>

</html>
<script>
  const select2 = document.querySelector(".select2");
  const filterForm = document.querySelector(".filterForm");
  const filterBtn = document.querySelector(".filterBtn");
  const close = document.querySelector(".close");
  const userLocation = document.querySelector(".userLocation");

  filterBtn.addEventListener('click', async()=>{
    if(select2.value === "closeToMe"){
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
      } else {
        alert("브라우저에서 현재 위치 정보를 지원하지 않습니다.")
        console.log("Geolocation is not supported by this browser.");
      }

       function successCallback(position) {
        const location = {
          latitude:position.coords.latitude,
          longitude:position.coords.longitude
        }
        console.log("Latitude: " + position.coords.latitude +
        ", Longitude: " + position.coords.longitude);
        console.log(JSON.stringify(location));
        userLocation.value = JSON.stringify(location);
        filterForm.submit();
      }

      function errorCallback(error) {
        console.log("Unable to retrieve your location due to " + error.code + ": " + error.message);
      }
    }
    else{
      filterForm.submit();
    }
  })

  //get user's geo

</script>